name: Coverage

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions: read-all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUST_MIN_STACK: 16777216

jobs:
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      with:
        components: llvm-tools-preview

    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@1c0532667bd5bc37f71fc223a52e7c41c966d9d7 # main
      with:
        tool: cargo-llvm-cov

    - name: Cache Cargo registry
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-coverage-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Generate coverage with llvm-cov
      run: |
        # Generate LCOV format for Codecov
        cargo llvm-cov --workspace --all-features --release --lcov --output-path lcov.info
        # Generate HTML report separately
        cargo llvm-cov --workspace --all-features --release --html

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238 # v4
      with:
        files: lcov.info
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload coverage reports
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
      with:
        name: coverage-reports
        path: |
          target/llvm-cov/html/
        retention-days: 30

  coverage-check:
    name: Coverage Threshold Check
    runs-on: ubuntu-latest
    needs: coverage
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      with:
        components: llvm-tools-preview

    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@1c0532667bd5bc37f71fc223a52e7c41c966d9d7 # main
      with:
        tool: cargo-llvm-cov

    - name: Cache Cargo registry
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-coverage-check-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Check coverage thresholds
      run: |
        
        # Generate coverage and check thresholds
        cargo llvm-cov --workspace --all-features --release --text > coverage.txt
        
        # Extract coverage percentage
        COVERAGE=$(grep "Total:" coverage.txt | awk '{print $2}' | sed 's/%//')
        echo "Current coverage: ${COVERAGE}%"
        
        # Check if coverage meets minimum threshold (80%)
        if (( $(echo "$COVERAGE < 80" | bc -l) )); then
          echo "❌ Coverage ${COVERAGE}% is below minimum threshold of 80%"
          exit 1
        else
          echo "✅ Coverage ${COVERAGE}% meets minimum threshold of 80%"
        fi

  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [coverage, coverage-check]
    if: always()
    steps:
    - name: Generate coverage summary
      run: |
        echo "# Coverage Report Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Coverage Generation | ${{ needs.coverage.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Coverage Threshold | ${{ needs.coverage-check.result }} |" >> $GITHUB_STEP_SUMMARY

    - name: Check overall status
      run: |
        if [[ "${{ needs.coverage.result }}" == "failure" || \
              "${{ needs.coverage-check.result }}" == "failure" ]]; then
          echo "❌ Coverage checks failed!"
          exit 1
        else
          echo "✅ Coverage checks passed!"
        fi