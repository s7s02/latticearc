# Sanitizers - Runtime Safety Checks
# Detects memory errors, data races, and undefined behavior at runtime

name: Sanitizers

on:
  # push/pull_request/schedule disabled to conserve GitHub Actions free tier minutes.
  # Re-enable when project is stable or on a paid plan.
  # push:
  #   branches: [main]
  # pull_request:
  #   branches: [main]
  # schedule:
  #   - cron: '0 4 * * 0'  # Weekly on Sunday at 4 AM UTC
  workflow_dispatch:

permissions: read-all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # AddressSanitizer - Detects memory errors
  asan:
    name: AddressSanitizer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # nightly
        with:
          components: rust-src

      - name: Cache Cargo registry
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-asan-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests with AddressSanitizer
        run: |
          RUSTFLAGS="-Z sanitizer=address" \
          cargo +nightly test --workspace --all-features \
            -Z build-std --target x86_64-unknown-linux-gnu \
            --lib -- --test-threads=1
        env:
          ASAN_OPTIONS: detect_leaks=1:detect_stack_use_after_return=1:check_initialization_order=1
        timeout-minutes: 60
        continue-on-error: true

      - name: ASan Summary
        if: always()
        run: |
          echo "## AddressSanitizer Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "AddressSanitizer detects:" >> $GITHUB_STEP_SUMMARY
          echo "- Use-after-free" >> $GITHUB_STEP_SUMMARY
          echo "- Heap buffer overflow" >> $GITHUB_STEP_SUMMARY
          echo "- Stack buffer overflow" >> $GITHUB_STEP_SUMMARY
          echo "- Global buffer overflow" >> $GITHUB_STEP_SUMMARY
          echo "- Use-after-return" >> $GITHUB_STEP_SUMMARY
          echo "- Memory leaks" >> $GITHUB_STEP_SUMMARY

  # ThreadSanitizer - Detects data races
  tsan:
    name: ThreadSanitizer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # nightly
        with:
          components: rust-src

      - name: Cache Cargo registry
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-tsan-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests with ThreadSanitizer
        run: |
          RUSTFLAGS="-Z sanitizer=thread" \
          cargo +nightly test --workspace --all-features \
            -Z build-std --target x86_64-unknown-linux-gnu \
            --lib -- --test-threads=1
        env:
          TSAN_OPTIONS: second_deadlock_stack=1:history_size=7
        timeout-minutes: 60
        continue-on-error: true

      - name: TSan Summary
        if: always()
        run: |
          echo "## ThreadSanitizer Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ThreadSanitizer detects:" >> $GITHUB_STEP_SUMMARY
          echo "- Data races" >> $GITHUB_STEP_SUMMARY
          echo "- Deadlocks" >> $GITHUB_STEP_SUMMARY
          echo "- Thread leaks" >> $GITHUB_STEP_SUMMARY

  # MemorySanitizer - Detects uninitialized memory reads
  msan:
    name: MemorySanitizer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # nightly
        with:
          components: rust-src

      - name: Cache Cargo registry
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-msan-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests with MemorySanitizer
        run: |
          RUSTFLAGS="-Z sanitizer=memory -Zsanitizer-memory-track-origins" \
          cargo +nightly test --workspace --all-features \
            -Z build-std --target x86_64-unknown-linux-gnu \
            --lib -- --test-threads=1
        env:
          MSAN_OPTIONS: poison_in_dtor=1
        timeout-minutes: 60
        continue-on-error: true

      - name: MSan Summary
        if: always()
        run: |
          echo "## MemorySanitizer Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "MemorySanitizer detects:" >> $GITHUB_STEP_SUMMARY
          echo "- Use of uninitialized memory" >> $GITHUB_STEP_SUMMARY
          echo "- Origin tracking for uninitialized values" >> $GITHUB_STEP_SUMMARY

  # LeakSanitizer - Detects memory leaks (standalone)
  lsan:
    name: LeakSanitizer
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@881ba7bf39a41cda34ac9e123fb41b44ed08232f # nightly
        with:
          components: rust-src

      - name: Cache Cargo registry
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-lsan-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests with LeakSanitizer
        run: |
          RUSTFLAGS="-Z sanitizer=leak" \
          cargo +nightly test --workspace --all-features \
            -Z build-std --target x86_64-unknown-linux-gnu \
            --lib -- --test-threads=1
        env:
          LSAN_OPTIONS: report_objects=1
        timeout-minutes: 60
        continue-on-error: true

      - name: LSan Summary
        if: always()
        run: |
          echo "## LeakSanitizer Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "LeakSanitizer detects:" >> $GITHUB_STEP_SUMMARY
          echo "- Memory leaks" >> $GITHUB_STEP_SUMMARY
          echo "- Leaked allocations with stack traces" >> $GITHUB_STEP_SUMMARY

  # Summary job
  sanitizer-summary:
    name: Sanitizer Summary
    runs-on: ubuntu-latest
    needs: [asan, tsan, msan, lsan]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# Sanitizer Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Sanitizer | Purpose | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| AddressSanitizer | Memory errors | ${{ needs.asan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ThreadSanitizer | Data races | ${{ needs.tsan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| MemorySanitizer | Uninitialized reads | ${{ needs.msan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| LeakSanitizer | Memory leaks | ${{ needs.lsan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Note: Sanitizers may report false positives in FFI code (aws-lc-rs)." >> $GITHUB_STEP_SUMMARY
          echo "LatticeArc workspace crates should have zero sanitizer violations." >> $GITHUB_STEP_SUMMARY
