# SBOM Generation - Software Bill of Materials
# Generates CycloneDX SBOM for compliance and transparency

name: SBOM

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  generate-sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-sbom-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-cyclonedx
        run: cargo install cargo-cyclonedx

      - name: Generate SBOM (JSON)
        run: |
          cargo cyclonedx --all --format json > sbom.cdx.json
          echo "Generated CycloneDX SBOM (JSON format)"

      - name: Generate SBOM (XML)
        run: |
          cargo cyclonedx --all --format xml > sbom.cdx.xml
          echo "Generated CycloneDX SBOM (XML format)"

      - name: Validate SBOM
        run: |
          # Basic validation - check files exist and have content
          if [ ! -s sbom.cdx.json ]; then
            echo "Error: SBOM JSON file is empty"
            exit 1
          fi
          if [ ! -s sbom.cdx.xml ]; then
            echo "Error: SBOM XML file is empty"
            exit 1
          fi
          echo "SBOM files validated successfully"

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom.cdx.json
            sbom.cdx.xml
          retention-days: 90

      - name: Generate SBOM summary
        run: |
          echo "## SBOM Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Format | File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|------|" >> $GITHUB_STEP_SUMMARY
          JSON_SIZE=$(wc -c < sbom.cdx.json | tr -d ' ')
          XML_SIZE=$(wc -c < sbom.cdx.xml | tr -d ' ')
          echo "| CycloneDX JSON | sbom.cdx.json | ${JSON_SIZE} bytes |" >> $GITHUB_STEP_SUMMARY
          echo "| CycloneDX XML | sbom.cdx.xml | ${XML_SIZE} bytes |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Component Count" >> $GITHUB_STEP_SUMMARY
          COMPONENTS=$(grep -o '"bom-ref"' sbom.cdx.json | wc -l | tr -d ' ')
          echo "Total components: ${COMPONENTS}" >> $GITHUB_STEP_SUMMARY

  attach-to-release:
    name: Attach SBOM to Release
    runs-on: ubuntu-latest
    needs: generate-sbom
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Download SBOM artifacts
        uses: actions/download-artifact@v4
        with:
          name: sbom

      - name: Attach SBOM to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            sbom.cdx.json
            sbom.cdx.xml
