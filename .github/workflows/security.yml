name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 3 * * *'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install cargo-audit
      run: cargo install cargo-audit

    - name: Run security audit
      run: |
        
        cargo audit --deny warnings --ignore RUSTSEC-2023-0052

    - name: Install cargo-deny
      run: cargo install cargo-deny

    - name: Check dependencies
      run: |
        
        cargo deny check all

  clippy-security:
    name: Clippy Security Lints
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-security-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run security-focused clippy
      run: |
        
        cargo clippy --workspace --all-targets --all-features -- \
          -D clippy::all \
          -D clippy::perf \
          -D clippy::style \
          -D clippy::complexity \
          -D clippy::correctness \
          -D clippy::suspicious \
          -D clippy::security \
          -D warnings

  memory-safety:
    name: Memory Safety Checks
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy

    - name: Install Valgrind
      run: sudo apt-get update && sudo apt-get install -y valgrind

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-memory-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Build with debug symbols
      run: |
        
        cargo build --workspace --all-features

    - name: Run Valgrind memory check
      run: |
        
        cargo test --workspace --all-features --no-run
        # Run critical tests under Valgrind
        valgrind --leak-check=full --error-exitcode=1 target/debug/deps/latticearc-*

  side-channel-analysis:
    name: Side Channel Analysis
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install timing analysis tools
      run: sudo apt-get update && sudo apt-get install -y time

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-sidechannel-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run timing analysis tests
      run: |
        
        cargo test --test statistical_timing_tests --all-features --release

    - name: Run side-channel resistance tests
      run: |
        
        cargo test --test side_channel_resistance --all-features --release

  cryptographic-tests:
    name: Cryptographic Security Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-crypto-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run NIST KAT compliance tests
      run: |
        
        cargo test --test nist_kat_compliance --all-features --release

    - name: Run FIPS 140-3 compliance tests
      run: |
        
        cargo test --test fips_140_3_compliance_tests --all-features --release

    - name: Run cryptographic correctness tests
      run: |
        
        cargo test --test ml_kem_correctness --all-features --release
        cargo test --test ml_dsa_correctness --all-features --release
        cargo test --test hybrid_encryption_correctness --all-features --release

  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install cargo-outdated
      run: cargo install cargo-outdated

    - name: Check for outdated dependencies
      run: |
        
        cargo outdated --workspace --exit-code 1

    - name: Install cargo-tree
      run: cargo install cargo-tree

    - name: Generate dependency tree
      run: |
        
        cargo tree --workspace --all-features > dependency_tree.txt

    - name: Upload dependency tree
      uses: actions/upload-artifact@v4
      with:
        name: dependency-tree
        path: dependency_tree.txt
        retention-days: 30

  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [security-audit, clippy-security, memory-safety, side-channel-analysis, cryptographic-tests, dependency-scan]
    if: always()
    steps:
    - name: Generate security summary
      run: |
        echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Security Audit | ${{ needs.security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Clippy Security | ${{ needs.clippy-security.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Memory Safety | ${{ needs.memory-safety.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Side Channel Analysis | ${{ needs.side-channel-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Cryptographic Tests | ${{ needs.cryptographic-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Dependency Scan | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY

    - name: Check overall status
      run: |
        if [[ "${{ needs.security-audit.result }}" == "failure" || \
              "${{ needs.clippy-security.result }}" == "failure" || \
              "${{ needs.memory-safety.result }}" == "failure" || \
              "${{ needs.side-channel-analysis.result }}" == "failure" || \
              "${{ needs.cryptographic-tests.result }}" == "failure" || \
              "${{ needs.dependency-scan.result }}" == "failure" ]]; then
          echo "❌ Security scan failed!"
          exit 1
        else
          echo "✅ All security checks passed!"
        fi