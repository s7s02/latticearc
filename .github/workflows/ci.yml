name: LatticeArc Apache CI/CD

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full
  RUSTFLAGS: "-C target-cpu=native -D warnings"
  # Repository type detection
  REPO_TYPE: apache
  # OpenTelemetry configuration
  OTEL_SERVICE_NAME: latticearc-apache-ci
  OTEL_TRACES_EXPORTER: otlp
  OTEL_EXPORTER_OTLP_ENDPOINT: ${{ secrets.OTEL_ENDPOINT || 'http://localhost:4318' }}
  OTEL_EXPORTER_OTLP_PROTOCOL: grpc
  # Prometheus metrics
  PROMETHEUS_PUSHGATEWAY: ${{ secrets.PROMETHEUS_PUSHGATEWAY || 'http://localhost:9091' }}

jobs:
  # === Code Quality Checks ===
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Setup OpenTelemetry
      run: |
        # Install OpenTelemetry collector (if not using external service)
        # For local testing, we'll use a mock setup
        echo "OpenTelemetry tracing enabled for CI quality checks"

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Check formatting
      run: |
        START_TIME=$(date +%s)
        cargo fmt --all -- --check
        END_TIME=$(date +%s)
        FMT_DURATION=$((END_TIME - START_TIME))
        echo "fmt_duration_seconds $FMT_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-quality/instance/${{ github.run_id }}/operation/fmt

    - name: Enhanced Clippy lints (Rust 2024)
      run: |
        START_TIME=$(date +%s)
        cargo clippy --workspace --all-targets --all-features -- \
          -D warnings \
          -D clippy::unwrap_used \
          -D clippy::expect_used \
          -D clippy::panic \
          -D clippy::todo \
          -D clippy::unimplemented \
          -W clippy::arithmetic_side_effects \
          -W clippy::cast_lossless \
          -W clippy::cast_possible_truncation \
          -W clippy::cast_precision_loss \
          -W clippy::float_cmp \
          -W clippy::implicit_clone
        END_TIME=$(date +%s)
        CLIPPY_DURATION=$((END_TIME - START_TIME))
        echo "clippy_duration_seconds $CLIPPY_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-quality/instance/${{ github.run_id }}/operation/clippy

    - name: Check documentation
      run: |
        START_TIME=$(date +%s)
        cargo doc --workspace --all-features --no-deps --document-private-items
        END_TIME=$(date +%s)
        DOC_DURATION=$((END_TIME - START_TIME))
        echo "doc_duration_seconds $DOC_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-quality/instance/${{ github.run_id }}/operation/doc

  # === Multi-Platform Builds ===
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: quality
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Build workspace
      run: |
        START_TIME=$(date +%s)
        cargo build --workspace --target ${{ matrix.target }} --release
        END_TIME=$(date +%s)
        BUILD_DURATION=$((END_TIME - START_TIME))
        echo "build_duration_seconds $BUILD_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-build/instance/${{ github.run_id }}/target/${{ matrix.target }}/operation/workspace-build

    - name: Test build artifacts
      run: |
        START_TIME=$(date +%s)
        cargo test --workspace --target ${{ matrix.target }} --release --no-run
        END_TIME=$(date +%s)
        ARTIFACT_TEST_DURATION=$((END_TIME - START_TIME))
        echo "artifact_test_duration_seconds $ARTIFACT_TEST_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-build/instance/${{ github.run_id }}/target/${{ matrix.target }}/operation/artifact-test

  # === Security Scanning (Enhanced for Rust 2024) ===
  security:
    name: Security & Supply Chain
    runs-on: ubuntu-latest
    needs: quality
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@stable

    - name: Install security tools
      run: |
        cargo install cargo-audit --version 0.20
        cargo install cargo-deny --version 0.16

    - name: Run cargo-audit (enhanced vulnerability scanning)
      run: |
        cargo audit --deny warnings --ignore RUSTSEC-2023-0052 || \
        (echo "Security vulnerabilities found!" && exit 1)

    - name: Run cargo-deny (license & dependency checks)
      run: cargo deny check all

    - name: Run cargo-checksec (binary security analysis)
      uses: rust-security/checksec-action@main

  # === Testing (Apache-focused) ===
  test:
    name: Tests (${{ matrix.profile }})
    runs-on: ubuntu-latest
    needs: [quality, build]
    strategy:
      matrix:
        profile: [debug, release]

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@stable
      with:
        components: llvm-tools-preview

    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@cargo-llvm-cov

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-test-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run unit tests
      run: |
        START_TIME=$(date +%s)
        cargo test --workspace --profile ${{ matrix.profile }} --all-features
        END_TIME=$(date +%s)
        TEST_DURATION=$((END_TIME - START_TIME))
        echo "unit_test_duration_seconds $TEST_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-test/instance/${{ github.run_id }}/profile/${{ matrix.profile }}/operation/unit-test

    - name: Run integration tests
      run: |
        START_TIME=$(date +%s)
        cargo test --workspace --profile ${{ matrix.profile }} --all-features --test '*'
        END_TIME=$(date +%s)
        INTEGRATION_DURATION=$((END_TIME - START_TIME))
        echo "integration_test_duration_seconds $INTEGRATION_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-test/instance/${{ github.run_id }}/profile/${{ matrix.profile }}/operation/integration-test

    - name: Run property-based tests
      run: |
        START_TIME=$(date +%s)
        cargo test --workspace --profile ${{ matrix.profile }} --all-features
        END_TIME=$(date +%s)
        PROPTEST_DURATION=$((END_TIME - START_TIME))
        echo "property_test_duration_seconds $PROPTEST_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-test/instance/${{ github.run_id }}/profile/${{ matrix.profile }}/operation/property-test

    - name: Formal verification (Apache)
      run: |
        START_TIME=$(date +%s)
        cargo install kani-verifier --version 0.53
        cargo kani --workspace --only-codegen
        END_TIME=$(date +%s)
        KANI_DURATION=$((END_TIME - START_TIME))
        echo "formal_verification_duration_seconds $KANI_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-test/instance/${{ github.run_id }}/profile/${{ matrix.profile }}/operation/formal-verification

    - name: Generate coverage report
      if: matrix.profile == 'debug'
      run: |
        START_TIME=$(date +%s)
        cargo llvm-cov --workspace --all-features --html --lcov --output-path lcov.info
        END_TIME=$(date +%s)
        COVERAGE_DURATION=$((END_TIME - START_TIME))
        # Extract coverage percentage
        COVERAGE=$(grep -o '"covered_percent":[0-9.]*' lcov.info | head -1 | grep -o '[0-9.]*' || echo "0")
        echo "coverage_generation_duration_seconds $COVERAGE_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-test/instance/${{ github.run_id }}/operation/coverage-generation
        echo "test_coverage_percent $COVERAGE" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-test/instance/${{ github.run_id }}/operation/test-coverage

    - name: Upload coverage to Codecov
      if: matrix.profile == 'debug'
      uses: codecov/codecov-action@v4
      with:
        files: lcov.info
        token: ${{ secrets.CODECOV_TOKEN }}

  # === Fuzzing (Apache crypto focus) ===
  fuzz:
    name: Fuzzing Tests
    runs-on: ubuntu-latest
    needs: [quality, build]
    strategy:
      matrix:
        fuzz-target: ["encrypt_fuzz", "cross_border_fuzz"]

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@stable

    - name: Install cargo-fuzz
      run: cargo install cargo-fuzz

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-fuzz-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run fuzz tests
      run: |
        cd arc-fuzz
        cargo fuzz run ${{ matrix.fuzz-target }} -- -max_total_time=60

    - name: Upload crash artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: fuzz-crash-${{ matrix.fuzz-target }}
        path: arc-fuzz/artifacts/${{ matrix.fuzz-target }}/

  # === Performance & Benchmarking ===
  performance:
    name: Performance Analysis
    runs-on: ubuntu-latest
    needs: [quality, build]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-bench-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run benchmarks
      run: |
        START_TIME=$(date +%s)
        
        cargo bench --workspace --all-features
        END_TIME=$(date +%s)
        BENCH_DURATION=$((END_TIME - START_TIME))
        echo "benchmark_duration_seconds $BENCH_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-performance/instance/${{ github.run_id }}/operation/benchmark-run

    - name: Performance regression detection
      uses: benchmark-action/github-action-benchmark@v1
      with:
        tool: 'cargo'
        output-file-path: target/criterion/reports/index.html
        github-token: ${{ secrets.GITHUB_TOKEN }}
        auto-push: true
        comment-on-alert: true
        alert-threshold: '200%'
        fail-on-alert: true

    - name: Record performance metrics
      run: |
        # Extract key performance metrics from benchmark results
        if [ -f target/criterion/reports/index.html ]; then
          # This is a simplified example - in practice you'd parse the HTML/JSON
          echo "performance_test_completed 1" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-performance/instance/${{ github.run_id }}/operation/performance-metrics
        fi

  # === Documentation & Release ===
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: [test]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-doc-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Test documentation examples
      run: cargo test --workspace --doc --all-features

    - name: Build documentation
      run: cargo doc --workspace --all-features --no-deps

    - name: Deploy documentation
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: target/doc
        destination_dir: apache

  # === Integration Tests ===
  integration:
    name: Integration Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [test]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
          - os: macos-latest
          - os: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-integration-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run end-to-end integration tests
      run: |
        
        cargo test --test e2e_integration --all-features
        cargo test --test unified_api_integration --all-features

    - name: Run compliance tests
      run: |
        
        cargo test --test nist_kat_compliance --all-features
        cargo test --test fips_140_3_compliance_tests --all-features

  # === Security Property Tests ===
  security-tests:
    name: Security Property Tests
    runs-on: ubuntu-latest
    needs: [test, security]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-security-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run security property tests
      run: |
        
        cargo test --test security_property_tests --all-features
        cargo test --test side_channel_resistance --all-features

    - name: Run statistical timing tests
      run: |
        
        cargo test --test statistical_timing_tests --all-features

  # === Release Validation ===
  release-validation:
    name: Release Validation
    runs-on: ${{ matrix.os }}
    needs: [test, build, security, integration, security-tests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Build release artifacts
      run: cargo build --workspace --target ${{ matrix.target }} --release --all-features

    - name: Test release artifacts
      run: cargo test --workspace --target ${{ matrix.target }} --release --all-features

    - name: Package and upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: apache-${{ matrix.target }}
        path: |
          target/${{ matrix.target }}/release/*latticearc*
          target/${{ matrix.target }}/release/liblatticearc*
        retention-days: 30

  # === Final Status Check ===
  status-check:
    name: Pipeline Status
    runs-on: ubuntu-latest
    needs: [quality, build, test, security, fuzz, performance, docs, integration, security-tests]
    if: always()
    steps:
    - name: Check all job statuses
      run: |
        echo "Checking job statuses..."
        failed_jobs=""

        # Check each job status explicitly
        [[ "${{ needs.quality.result }}" == "failure" ]] && failed_jobs="$failed_jobs quality"
        [[ "${{ needs.build.result }}" == "failure" ]] && failed_jobs="$failed_jobs build"
        [[ "${{ needs.test.result }}" == "failure" ]] && failed_jobs="$failed_jobs test"
        [[ "${{ needs.security.result }}" == "failure" ]] && failed_jobs="$failed_jobs security"
        [[ "${{ needs.fuzz.result }}" == "failure" ]] && failed_jobs="$failed_jobs fuzz"
        [[ "${{ needs.docs.result }}" == "failure" ]] && failed_jobs="$failed_jobs docs"
        [[ "${{ needs.integration.result }}" == "failure" ]] && failed_jobs="$failed_jobs integration"
        [[ "${{ needs.security-tests.result }}" == "failure" ]] && failed_jobs="$failed_jobs security-tests"

        if [ -n "$failed_jobs" ]; then
          echo "❌ Critical jobs failed:$failed_jobs"
          echo "PIPELINE_STATUS=failed" >> $GITHUB_ENV
          exit 1
        else
          echo "✅ All critical checks passed!"
          echo "PIPELINE_STATUS=success" >> $GITHUB_ENV
        fi

    - name: Generate pipeline report
      run: |
        echo "## LatticeArc Apache CI/CD Report" > report.md
        echo "- **Repository**: ${{ github.repository }}" >> report.md
        echo "- **Branch**: ${{ github.ref }}" >> report.md
        echo "- **Commit**: ${{ github.sha }}" >> report.md
        echo "- **Status**: ${{ env.PIPELINE_STATUS }}" >> report.md
        echo "- **Timestamp**: $(date -u)" >> report.md
        echo "- **Telemetry**: Enabled (OpenTelemetry + Prometheus)" >> report.md

    - name: Upload pipeline report
      uses: actions/upload-artifact@v4
      with:
        name: pipeline-report
        path: report.md