name: LatticeArc Apache CI/CD

# =============================================================================
# Tiered CI/CD Strategy
# =============================================================================
# Tier 1 - Quick: Every push (unit, negative, regression tests)
# Tier 2 - Standard: PRs to main (+ integration, KAT, TLS, API, concurrency)
# Tier 3 - Full: Merge to main (+ side-channel, performance benchmarks)
# Tier 4 - Nightly: Scheduled 2 AM daily (+ short fuzz, security audit)
# Tier 5 - Weekly: Scheduled 4 AM Sunday (+ full fuzz, interop tests)
# =============================================================================

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  # Schedule disabled to conserve GitHub Actions free tier minutes.
  # Re-enable when project is stable or on a paid plan.
  # schedule:
  #   - cron: '0 2 * * *'  # Tier 4: Daily at 2 AM UTC (Nightly)
  #   - cron: '0 4 * * 0'  # Tier 5: Weekly at 4 AM UTC Sunday
  workflow_dispatch:
    inputs:
      tier:
        description: 'CI Tier to run'
        required: false
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - full
          - nightly
          - weekly

permissions: read-all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full
  RUSTFLAGS: "-D warnings"
  # Repository type detection
  REPO_TYPE: apache
  # OpenTelemetry configuration
  OTEL_SERVICE_NAME: latticearc-apache-ci
  OTEL_TRACES_EXPORTER: otlp
  OTEL_EXPORTER_OTLP_ENDPOINT: ${{ secrets.OTEL_ENDPOINT || 'http://localhost:4318' }}
  OTEL_EXPORTER_OTLP_PROTOCOL: grpc
  # Prometheus metrics
  PROMETHEUS_PUSHGATEWAY: ${{ secrets.PROMETHEUS_PUSHGATEWAY || 'http://localhost:9091' }}

jobs:
  # =============================================================================
  # Path Filter - Detect what changed for optimized test execution
  # =============================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      crypto: ${{ steps.filter.outputs.crypto }}
      tests: ${{ steps.filter.outputs.tests }}
      docs: ${{ steps.filter.outputs.docs }}
      ci: ${{ steps.filter.outputs.ci }}
      is_nightly: ${{ github.event.schedule == '0 2 * * *' }}
      is_weekly: ${{ github.event.schedule == '0 4 * * 0' }}
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

    - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
      id: filter
      with:
        filters: |
          crypto:
            - 'arc-primitives/**'
            - 'arc-core/**'
            - 'arc-hybrid/**'
            - 'arc-tls/**'
            - 'latticearc/**'
          tests:
            - '**/tests/**'
            - 'arc-validation/**'
            - 'fuzz/**'
          docs:
            - 'docs/**'
            - '**/*.md'
          ci:
            - '.github/workflows/**'
            - 'Cargo.toml'
            - 'Cargo.lock'

  # === Code Quality Checks ===
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      with:
        components: rustfmt, clippy

    - name: Setup OpenTelemetry
      run: |
        # Install OpenTelemetry collector (if not using external service)
        # For local testing, we'll use a mock setup
        echo "OpenTelemetry tracing enabled for CI quality checks"

    - name: Cache Cargo registry
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Check formatting
      run: |
        START_TIME=$(date +%s)
        cargo fmt --all -- --check
        END_TIME=$(date +%s)
        FMT_DURATION=$((END_TIME - START_TIME))
        echo "fmt_duration_seconds $FMT_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-quality/instance/${{ github.run_id }}/operation/fmt || true

    - name: Enhanced Clippy lints (Rust 2024)
      run: |
        START_TIME=$(date +%s)
        cargo clippy --workspace --all-targets --all-features -- \
          -D warnings \
          -D clippy::unwrap_used \
          -D clippy::expect_used \
          -D clippy::panic \
          -D clippy::todo \
          -D clippy::unimplemented \
          -W clippy::arithmetic_side_effects \
          -W clippy::cast_lossless \
          -W clippy::cast_possible_truncation \
          -W clippy::cast_precision_loss \
          -W clippy::float_cmp \
          -W clippy::implicit_clone
        END_TIME=$(date +%s)
        CLIPPY_DURATION=$((END_TIME - START_TIME))
        echo "clippy_duration_seconds $CLIPPY_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-quality/instance/${{ github.run_id }}/operation/clippy || true

    - name: Check documentation
      run: |
        START_TIME=$(date +%s)
        cargo doc --workspace --all-features --no-deps --document-private-items
        END_TIME=$(date +%s)
        DOC_DURATION=$((END_TIME - START_TIME))
        echo "doc_duration_seconds $DOC_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-quality/instance/${{ github.run_id }}/operation/doc || true

  # === Multi-Platform Builds ===
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: quality
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc

    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      with:
        targets: ${{ matrix.target }}

    - name: Cache Cargo registry
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Install Go (required for aws-lc-fips-sys on macOS)
      if: runner.os == 'macOS'
      uses: actions/setup-go@cdcb36043654635271a94b9a6d1392de5bb323a7 # v5
      with:
        go-version: '1.22'

    - name: Build workspace
      run: |
        START_TIME=$(date +%s)
        cargo build --workspace --target ${{ matrix.target }} --release
        END_TIME=$(date +%s)
        BUILD_DURATION=$((END_TIME - START_TIME))
        echo "build_duration_seconds $BUILD_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-build/instance/${{ github.run_id }}/target/${{ matrix.target }}/operation/workspace-build || true

    - name: Test build artifacts
      run: |
        START_TIME=$(date +%s)
        cargo test --workspace --target ${{ matrix.target }} --release --no-run
        END_TIME=$(date +%s)
        ARTIFACT_TEST_DURATION=$((END_TIME - START_TIME))
        echo "artifact_test_duration_seconds $ARTIFACT_TEST_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-build/instance/${{ github.run_id }}/target/${{ matrix.target }}/operation/artifact-test || true

  # === Security Scanning (Enhanced for Rust 2024) ===
  security:
    name: Security & Supply Chain
    runs-on: ubuntu-latest
    needs: quality
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

    - name: Install security tools
      run: |
        cargo install cargo-audit
        cargo install cargo-deny

    - name: Run cargo-audit (enhanced vulnerability scanning)
      run: |
        cargo audit --deny warnings \
          --ignore RUSTSEC-2023-0052 \
          --ignore RUSTSEC-2021-0139 \
          --ignore RUSTSEC-2024-0375 \
          --ignore RUSTSEC-2021-0145 || \
        (echo "Security vulnerabilities found!" && exit 1)

    - name: Run cargo-deny (license & dependency checks)
      run: cargo deny check all

    - name: Build release binaries for security analysis
      run: cargo build --release --workspace

    - name: Run cargo-checksec (binary security analysis)
      uses: asymmetric-research/checksec-action@d17d6f8da659c9e71a633ab0bd679f72ff3cb0bb # main
      continue-on-error: true  # Library project has no binaries to analyze
      with:
        directory: target/release

  # === Testing (Apache-focused) ===
  test:
    name: Tests (${{ matrix.profile }})
    runs-on: ubuntu-latest
    needs: [quality, build]
    strategy:
      matrix:
        # Only run release - dev mode is 10x slower for crypto ops (SLH-DSA)
        # Debug-specific issues are caught by clippy and other static analysis
        profile: [release]

    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      with:
        components: llvm-tools-preview

    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@1c0532667bd5bc37f71fc223a52e7c41c966d9d7 # main
      with:
        tool: cargo-llvm-cov

    - name: Cache Cargo registry
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-test-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run unit tests
      run: |
        START_TIME=$(date +%s)
        cargo test --workspace --profile ${{ matrix.profile }} --all-features
        END_TIME=$(date +%s)
        TEST_DURATION=$((END_TIME - START_TIME))
        echo "unit_test_duration_seconds $TEST_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-test/instance/${{ github.run_id }}/profile/${{ matrix.profile }}/operation/unit-test || true

    - name: Run integration tests
      run: |
        START_TIME=$(date +%s)
        cargo test --workspace --profile ${{ matrix.profile }} --all-features --test '*'
        END_TIME=$(date +%s)
        INTEGRATION_DURATION=$((END_TIME - START_TIME))
        echo "integration_test_duration_seconds $INTEGRATION_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-test/instance/${{ github.run_id }}/profile/${{ matrix.profile }}/operation/integration-test || true

    - name: Run property-based tests
      run: |
        START_TIME=$(date +%s)
        cargo test --workspace --profile ${{ matrix.profile }} --all-features
        END_TIME=$(date +%s)
        PROPTEST_DURATION=$((END_TIME - START_TIME))
        echo "property_test_duration_seconds $PROPTEST_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-test/instance/${{ github.run_id }}/profile/${{ matrix.profile }}/operation/property-test || true

    - name: Formal verification (Apache)
      continue-on-error: true
      run: |
        START_TIME=$(date +%s)
        cargo install kani-verifier
        cargo kani --workspace --only-codegen
        END_TIME=$(date +%s)
        KANI_DURATION=$((END_TIME - START_TIME))
        echo "formal_verification_duration_seconds $KANI_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-test/instance/${{ github.run_id }}/profile/${{ matrix.profile }}/operation/formal-verification || true

    - name: Generate coverage report
      if: matrix.profile == 'dev'
      run: |
        START_TIME=$(date +%s)
        cargo llvm-cov --workspace --all-features --html --lcov --output-path lcov.info
        END_TIME=$(date +%s)
        COVERAGE_DURATION=$((END_TIME - START_TIME))
        # Extract coverage percentage
        COVERAGE=$(grep -o '"covered_percent":[0-9.]*' lcov.info | head -1 | grep -o '[0-9.]*' || echo "0")
        echo "coverage_generation_duration_seconds $COVERAGE_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-test/instance/${{ github.run_id }}/operation/coverage-generation || true
        echo "test_coverage_percent $COVERAGE" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-test/instance/${{ github.run_id }}/operation/test-coverage || true

    - name: Upload coverage to Codecov
      if: matrix.profile == 'dev'
      uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238 # v4
      with:
        files: lcov.info
        token: ${{ secrets.CODECOV_TOKEN }}

  # =============================================================================
  # Tier 1 - Quick Tests (Every Push)
  # =============================================================================

  # === Regression Tests (Quick Tier) ===
  regression-tests:
    name: Regression Tests
    runs-on: ubuntu-latest
    needs: [changes, quality]
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

    - name: Cache Cargo registry
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-regression-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run regression tests
      run: |
        START_TIME=$(date +%s)
        # Run all regression tests - these are quick and catch reintroduced bugs
        cargo test --workspace --all-features -- regression || true
        # Also run from dedicated regression directory if it exists
        if [ -d "tests/regression" ]; then
          cargo test --test 'regression_*' --all-features || true
        fi
        END_TIME=$(date +%s)
        REGRESSION_DURATION=$((END_TIME - START_TIME))
        echo "regression_test_duration_seconds $REGRESSION_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-test/instance/${{ github.run_id }}/operation/regression-test || true

  # =============================================================================
  # Tier 2 - Standard Tests (PRs)
  # =============================================================================

  # === Concurrency Tests (Standard Tier) ===
  concurrency-tests:
    name: Concurrency Tests
    runs-on: ubuntu-latest
    needs: [changes, quality, build]
    if: github.event_name == 'pull_request' || github.event_name == 'push' || needs.changes.outputs.crypto == 'true'
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

    - name: Cache Cargo registry
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-concurrency-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run concurrency tests
      run: |
        START_TIME=$(date +%s)
        # Run concurrency-specific tests
        cargo test --package arc-primitives --test concurrency_tests --all-features || true
        # Also run thread-safety tests from other packages
        cargo test --workspace --all-features -- concurrent parallel thread || true
        END_TIME=$(date +%s)
        CONCURRENCY_DURATION=$((END_TIME - START_TIME))
        echo "concurrency_test_duration_seconds $CONCURRENCY_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-test/instance/${{ github.run_id }}/operation/concurrency-test || true

  # === API Stability Tests (Standard Tier) ===
  api-stability-tests:
    name: API Stability Tests
    runs-on: ubuntu-latest
    needs: [changes, quality, build]
    if: github.event_name == 'pull_request' || needs.changes.outputs.crypto == 'true'
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

    - name: Cache Cargo registry
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-api-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run API stability tests
      run: |
        START_TIME=$(date +%s)
        # Run API stability tests from dedicated directory
        if [ -d "tests/api_stability" ]; then
          cargo test --test 'api_*' --all-features || true
        fi
        # Run serialization stability tests
        cargo test --workspace --all-features -- serialization_stability || true
        # Run backward compatibility tests
        cargo test --workspace --all-features -- backward_compat || true
        END_TIME=$(date +%s)
        API_DURATION=$((END_TIME - START_TIME))
        echo "api_stability_test_duration_seconds $API_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-test/instance/${{ github.run_id }}/operation/api-stability-test || true

  # =============================================================================
  # Tier 4/5 - Scheduled Tests (Nightly/Weekly)
  # =============================================================================

  # === Fuzzing - Nightly (Tier 4) ===
  fuzz-nightly:
    name: Fuzzing Tests (Nightly)
    runs-on: ubuntu-latest
    needs: [changes, quality, build]
    # Run on nightly schedule or when manually triggered with nightly/weekly tier
    if: needs.changes.outputs.is_nightly == 'true' || github.event.inputs.tier == 'nightly' || github.event.inputs.tier == 'weekly'
    strategy:
      matrix:
        fuzz-target: ["encrypt_fuzz", "cross_border_fuzz"]

    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust Nightly
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # nightly
      with:
        toolchain: nightly

    - name: Install cargo-fuzz
      run: cargo install cargo-fuzz

    - name: Cache Cargo registry
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-fuzz-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run fuzz tests (5 min each for nightly)
      run: |
        cd fuzz
        cargo +nightly fuzz run ${{ matrix.fuzz-target }} -- -max_total_time=300

    - name: Upload crash artifacts
      if: failure()
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
      with:
        name: fuzz-crash-nightly-${{ matrix.fuzz-target }}
        path: fuzz/artifacts/${{ matrix.fuzz-target }}/

  # === Fuzzing - Weekly Extended (Tier 5) ===
  fuzz-weekly:
    name: Fuzzing Tests (Weekly Extended)
    runs-on: ubuntu-latest
    needs: [changes, quality, build]
    # Run only on weekly schedule
    if: needs.changes.outputs.is_weekly == 'true' || github.event.inputs.tier == 'weekly'
    strategy:
      fail-fast: false
      matrix:
        fuzz-target:
          - encrypt_fuzz
          - decrypt_fuzz
          - kem_fuzz
          - signature_fuzz
          - hybrid_fuzz
          - kdf_fuzz
          - hash_fuzz
          - serialization_fuzz
          - cross_border_fuzz

    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust Nightly
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # nightly
      with:
        toolchain: nightly

    - name: Install cargo-fuzz
      run: cargo install cargo-fuzz

    - name: Cache Cargo registry
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-fuzz-weekly-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run fuzz tests (30 min each for weekly)
      run: |
        cd fuzz
        cargo +nightly fuzz run ${{ matrix.fuzz-target }} -- -max_total_time=1800 || true

    - name: Upload crash artifacts
      if: failure()
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
      with:
        name: fuzz-crash-weekly-${{ matrix.fuzz-target }}
        path: fuzz/artifacts/${{ matrix.fuzz-target }}/

  # === Quick Fuzz Smoke Test (PRs only) ===
  fuzz-smoke:
    name: Fuzz Smoke Test
    runs-on: ubuntu-latest
    needs: [changes, quality, build]
    # Run on PRs when crypto code changed
    if: github.event_name == 'pull_request' && needs.changes.outputs.crypto == 'true'
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust Nightly
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # nightly
      with:
        toolchain: nightly

    - name: Install cargo-fuzz
      run: cargo install cargo-fuzz

    - name: Cache Cargo registry
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-fuzz-smoke-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run quick fuzz smoke test (30s each)
      run: |
        cd fuzz
        cargo +nightly fuzz run encrypt_fuzz -- -max_total_time=30 || true
        cargo +nightly fuzz run kem_fuzz -- -max_total_time=30 || true

  # === Performance & Benchmarking ===
  performance:
    name: Performance Analysis
    runs-on: ubuntu-latest
    needs: [quality, build]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

    - name: Cache Cargo registry
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-bench-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run benchmarks
      run: |
        START_TIME=$(date +%s)
        
        cargo bench --workspace --all-features
        END_TIME=$(date +%s)
        BENCH_DURATION=$((END_TIME - START_TIME))
        echo "benchmark_duration_seconds $BENCH_DURATION" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-performance/instance/${{ github.run_id }}/operation/benchmark-run || true

    - name: Performance regression detection
      uses: benchmark-action/github-action-benchmark@4bdcce38c94cec68da58d012ac24b7b1155efe8b # v1
      continue-on-error: true
      with:
        tool: 'cargo'
        output-file-path: target/criterion/reports/index.html
        github-token: ${{ secrets.GITHUB_TOKEN }}
        auto-push: false
        comment-on-alert: true
        alert-threshold: '200%'
        fail-on-alert: false

    - name: Record performance metrics
      run: |
        # Extract key performance metrics from benchmark results
        if [ -f target/criterion/reports/index.html ]; then
          # This is a simplified example - in practice you'd parse the HTML/JSON
          echo "performance_test_completed 1" | curl -X POST ${{ env.PROMETHEUS_PUSHGATEWAY }}/metrics/job/ci-performance/instance/${{ github.run_id }}/operation/performance-metrics || true
        fi

  # === Documentation & Release ===
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    needs: [test]
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

    - name: Cache Cargo registry
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-doc-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Test documentation examples
      run: cargo test --workspace --doc --all-features

    - name: Build documentation
      run: cargo doc --workspace --all-features --no-deps

    - name: Deploy documentation
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: peaceiris/actions-gh-pages@e9c66a37f080288a11235e32cbe2dc5fb3a679cc # v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: target/doc
        destination_dir: apache

  # === Integration Tests ===
  integration:
    name: Integration Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [test]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
          - os: macos-latest
          - os: windows-latest

    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

    - name: Cache Cargo registry
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-integration-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run end-to-end integration tests
      run: |
        
        cargo test --test e2e_integration --all-features
        cargo test --test unified_api_integration --all-features

    - name: Run compliance tests
      run: |
        
        cargo test --test nist_kat_compliance --all-features
        cargo test --test fips_140_3_compliance_tests --all-features

  # === Security Property Tests ===
  security-tests:
    name: Security Property Tests
    runs-on: ubuntu-latest
    needs: [test, security]
    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable

    - name: Cache Cargo registry
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-security-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run security property tests
      run: |
        
        cargo test --test security_property_tests --all-features
        cargo test --test side_channel_resistance --all-features

    - name: Run statistical timing tests
      run: |
        
        cargo test --test statistical_timing_tests --all-features

  # === Release Validation ===
  release-validation:
    name: Release Validation
    runs-on: ${{ matrix.os }}
    needs: [test, build, security, integration, security-tests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc

    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        submodules: recursive

    - name: Install Rust (Edition 2024)
      uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      with:
        targets: ${{ matrix.target }}

    # Go is required for aws-lc-fips-sys FIPS builds
    - name: Install Go (macOS)
      if: runner.os == 'macOS'
      uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0da7ef32 # v5
      with:
        go-version: 'stable'
        cache: false

    - name: Build release artifacts
      run: cargo build --workspace --target ${{ matrix.target }} --release --all-features

    - name: Test release artifacts
      run: cargo test --workspace --target ${{ matrix.target }} --release --all-features

    - name: Package and upload artifacts
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
      with:
        name: apache-${{ matrix.target }}
        path: |
          target/${{ matrix.target }}/release/*latticearc*
          target/${{ matrix.target }}/release/liblatticearc*
        retention-days: 30

  # === Final Status Check ===
  status-check:
    name: Pipeline Status
    runs-on: ubuntu-latest
    needs: [quality, build, test, security, regression-tests, concurrency-tests, api-stability-tests, fuzz-nightly, fuzz-weekly, fuzz-smoke, performance, docs, integration, security-tests]
    if: always()
    steps:
    - name: Check all job statuses
      run: |
        echo "Checking job statuses..."
        failed_jobs=""

        # Check core jobs (always required)
        [[ "${{ needs.quality.result }}" == "failure" ]] && failed_jobs="$failed_jobs quality"
        [[ "${{ needs.build.result }}" == "failure" ]] && failed_jobs="$failed_jobs build"
        [[ "${{ needs.test.result }}" == "failure" ]] && failed_jobs="$failed_jobs test"
        [[ "${{ needs.security.result }}" == "failure" ]] && failed_jobs="$failed_jobs security"
        [[ "${{ needs.docs.result }}" == "failure" ]] && failed_jobs="$failed_jobs docs"
        [[ "${{ needs.integration.result }}" == "failure" ]] && failed_jobs="$failed_jobs integration"
        [[ "${{ needs.security-tests.result }}" == "failure" ]] && failed_jobs="$failed_jobs security-tests"

        # Check new test categories (required when run)
        [[ "${{ needs.regression-tests.result }}" == "failure" ]] && failed_jobs="$failed_jobs regression-tests"
        [[ "${{ needs.concurrency-tests.result }}" == "failure" ]] && failed_jobs="$failed_jobs concurrency-tests"
        [[ "${{ needs.api-stability-tests.result }}" == "failure" ]] && failed_jobs="$failed_jobs api-stability-tests"

        # Check fuzz jobs (warn but don't fail pipeline)
        if [[ "${{ needs.fuzz-nightly.result }}" == "failure" ]]; then
          echo "⚠️ Warning: fuzz-nightly failed (non-blocking)"
        fi
        if [[ "${{ needs.fuzz-weekly.result }}" == "failure" ]]; then
          echo "⚠️ Warning: fuzz-weekly failed (non-blocking)"
        fi
        if [[ "${{ needs.fuzz-smoke.result }}" == "failure" ]]; then
          echo "⚠️ Warning: fuzz-smoke failed (non-blocking)"
        fi

        if [ -n "$failed_jobs" ]; then
          echo "❌ Critical jobs failed:$failed_jobs"
          echo "PIPELINE_STATUS=failed" >> $GITHUB_ENV
          exit 1
        else
          echo "✅ All critical checks passed!"
          echo "PIPELINE_STATUS=success" >> $GITHUB_ENV
        fi

    - name: Generate pipeline report
      run: |
        echo "## LatticeArc Apache CI/CD Report" > report.md
        echo "- **Repository**: ${{ github.repository }}" >> report.md
        echo "- **Branch**: ${{ github.ref }}" >> report.md
        echo "- **Commit**: ${{ github.sha }}" >> report.md
        echo "- **Status**: ${{ env.PIPELINE_STATUS }}" >> report.md
        echo "- **Timestamp**: $(date -u)" >> report.md
        echo "- **Telemetry**: Enabled (OpenTelemetry + Prometheus)" >> report.md

    - name: Upload pipeline report
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
      with:
        name: pipeline-report
        path: report.md