name: Performance

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 4 * * *'

permissions: read-all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTFLAGS: "-C target-cpu=native"

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-bench-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run benchmarks
      run: |
        
        cargo bench --workspace --all-features

    - name: Store benchmark result
      uses: benchmark-action/github-action-benchmark@v1
      with:
        tool: 'cargo'
        output-file-path: target/criterion/reports/index.html
        github-token: ${{ secrets.GITHUB_TOKEN }}
        auto-push: true
        comment-on-alert: true
        alert-threshold: '200%'

  performance-regression:
    name: Performance Regression Tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-perf-regression-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Run performance regression tests
      run: |
        
        cargo test --test performance_regression_tests --all-features --release

  profiling:
    name: Performance Profiling
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install profiling tools
      run: sudo apt-get update && sudo apt-get install -y linux-tools-generic

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-profiling-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Build with profiling symbols
      run: |
        
        cargo build --workspace --release --all-features

    - name: Run CPU profiling
      run: |
        
        perf record --call-graph=dwarf target/release/latticearc --help
        perf report > perf_report.txt

    - name: Upload profiling results
      uses: actions/upload-artifact@v4
      with:
        name: profiling-results
        path: perf_report.txt
        retention-days: 30

  memory-profiling:
    name: Memory Profiling
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install memory profiling tools
      run: sudo apt-get update && sudo apt-get install -y valgrind massif-visualizer

    - name: Cache Cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-memory-profiling-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Build with debug symbols
      run: |
        
        cargo build --workspace --all-features

    - name: Run memory profiling
      run: |
        
        valgrind --tool=massif --massif-out-file=massif.out target/debug/latticearc --help
        ms_print massif.out > memory_profile.txt

    - name: Upload memory profiling results
      uses: actions/upload-artifact@v4
      with:
        name: memory-profiling-results
        path: memory_profile.txt
        retention-days: 30

  performance-report:
    name: Performance Report
    runs-on: ubuntu-latest
    needs: [benchmark, performance-regression, profiling, memory-profiling]
    if: always()
    steps:
    - name: Generate performance summary
      run: |
        echo "# Performance Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Benchmarks | ${{ needs.benchmark.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Performance Regression | ${{ needs.performance-regression.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Profiling | ${{ needs.profiling.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Memory Profiling | ${{ needs.memory-profiling.result }} |" >> $GITHUB_STEP_SUMMARY

    - name: Check overall status
      run: |
        if [[ "${{ needs.benchmark.result }}" == "failure" || \
              "${{ needs.performance-regression.result }}" == "failure" ]]; then
          echo "❌ Performance tests failed!"
          exit 1
        else
          echo "✅ Performance tests passed!"
        fi